---
title: "Learning Quarto using Tethys data"
format: html
author: "Enrico Pirotta"
date: "08/23/2023"
editor: visual
link-citations: true
csl: mee.csl
bibliography: references.bib

---

```{r}
#| echo: false
#| warning: false

# Load packages
library(tidyverse)
library(networkD3)
library(stringr)
library(viridis)
library(writexl)
library(htmlwidgets)
library(knitr)
library(tmap)
library(leaflet)
library(leaflet.minicharts)
library(sf)

# Load Saana's data
load("D:/Documents/Quarto_training_23Aug2023/LearningQuarto/Data/1_tethys_docs_2023-08-13.Rd")

# Pre-processing
  
# Avoid NAs in filtering
df_all$Technology[is.na(df_all$Technology)] <- ""
df_all$Stressor[is.na(df_all$Stressor)] <- ""
df_all$Receptor[is.na(df_all$Receptor)] <- ""

# Identify based on institution
df_all$USTAN <- str_detect(str_to_lower(df_all$Affiliation), "university of st andrews") | 
    str_detect(str_to_lower(df_all$Affiliation), "sea mammal research unit") | 
    str_detect(str_to_lower(df_all$Affiliation), "smru") | 
    str_detect(str_to_lower(df_all$Affiliation), "creem")
  
  df_all$USTAN[is.na(df_all$Affiliation)] <- FALSE

names(df_all)[names(df_all)=="Sponsoring Organization"] <- "Sponsor"
  
df_all$USTAN2 <- "Other"
df_all$USTAN2[df_all$USTAN] <- "St Andrews"
  
df_all$Marine <- str_detect(str_to_lower(df_all$Technology), "offshore") |
                   str_detect(str_to_lower(df_all$Technology), "wave") |
                   str_detect(str_to_lower(df_all$Technology), "tidal") |
                   str_detect(str_to_lower(df_all$Technology), "marine")
  
```

## Top sponsors

Table of number of publications by top-listed sponsors. The USTAN column indicates how many where generated by the University of St Andrews.

```{r}
#| echo: false

top_sponsors <-   df_all %>%
                       separate_rows(Sponsor, sep = ",")  %>%
                       mutate_at(vars(Sponsor), str_trim) %>%
                       mutate(MarineTech = str_detect(str_to_lower(Technology), "offshore") | 
                                str_detect(str_to_lower(Technology), "wave") | 
                                str_detect(str_to_lower(Technology), "tidal") | 
                                str_detect(str_to_lower(Technology), "marine")) %>%
                       mutate(MarMammals = str_detect(str_to_lower(Receptor), "marine mammals")) %>%
                       mutate(Birds = str_detect(str_to_lower(Receptor), "birds")) %>%
                       mutate(FishFisheries = str_detect(str_to_lower(Receptor), "fish")) %>%
                       mutate(Inverteb = str_detect(str_to_lower(Receptor), "invertebrate")) %>%
                       mutate(SocialHumanJustice = str_detect(str_to_lower(Receptor), "social") |
                                str_detect(str_to_lower(Receptor), "human") | 
                                str_detect(str_to_lower(Receptor), "justice")) %>%
                       group_by(Sponsor) %>% 
                       drop_na(Sponsor) %>%
                       summarize(
                         N = length(Year), 
                         USTAN = sum(USTAN),
                         MarineTech = mean(MarineTech, na.rm=T)*100,
                         MarMammals = mean(MarMammals, na.rm=T)*100, 
                         Birds = mean(Birds, na.rm=T)*100,
                         Fish = mean(FishFisheries, na.rm=T)*100,
                         Inverteb = mean(Inverteb, na.rm=T)*100) %>%
                         arrange(desc(N),desc(USTAN)) %>%
                         filter(N >= 20)
  
kable(top_sponsors, "html", digit = 0)

```


The following pie chart plots the proportion of publications by top-listed sponsors.

```{r}
#| echo: false

top_sponsors %>% 
  arrange(desc(Sponsor)) %>%
  mutate(prop = N / sum(top_sponsors$N) *100) %>%
  mutate(ypos = cumsum(prop)- 0.5*prop ) %>% 
  ggplot(aes(x = "", y = prop, 
             fill = Sponsor)) +
  geom_bar(stat = "identity", 
           width = 1, 
           color = "white") +
  coord_polar("y", start = 0) +
  theme_void() 
```
 
## Time series plot with technology type

Here I am plotting the number of publications by technology type over the years.

```{r} 
#| echo: false
#| warning: false

df_all %>% 
  filter(Marine) %>% 
  separate_rows(Technology, sep = ",")  %>%
  mutate_at(vars(Technology), str_trim) %>%
  filter(Technology != "Wind Energy") %>%
  filter(Technology != "Marine Energy") %>% 
  group_by(Year, Technology) %>% 
  summarize(N = length(Year))  %>% 
  ggplot(aes(x =Year, y = N, 
               group = Technology, 
               fill = Technology)) + 
  geom_bar(stat = "identity") +
  xlim(c(1980, 2023)) +
  theme_bw()
  
```

## Sankey diagram

Plotting the connections between technologies, stressors and receptors.

```{r}
#| echo: false
#| warning: false
#| 
my_sep <- c(",", ",", ",")
N_min <- 0
links <- df_all %>% 
    filter(Marine) %>%
    drop_na(Stressor) %>%
    filter(Stressor != "") %>% 
    mutate(var1 = Technology,
           var2 = Stressor,
           var3 = Receptor) %>% 
    drop_na(var1) %>% 
    drop_na(var2) %>% 
    separate_rows(var1, sep = my_sep[1])  %>%
    mutate_at(vars(var1), str_trim) %>%
    separate_rows(var2, sep = my_sep[2])  %>%
    mutate_at(vars(var2), str_trim) %>%
    select(var1, var2) %>%
    count(var1, var2) %>% 
    filter(n >= N_min) %>%
    rename(source = var1,
           target = var2)
    
links2 <- df_all %>% 
    filter(Marine) %>%
    drop_na(Stressor) %>%
    filter(Stressor != "") %>% 
    mutate(var1 = Technology,
           var2 = Stressor,
           var3 = Receptor) %>% 
        drop_na(var2) %>% 
        drop_na(var3) %>% 
        separate_rows(var1, sep = my_sep[1])  %>%
        mutate_at(vars(var1), str_trim) %>%
        separate_rows(var2, sep = my_sep[2])  %>%
        mutate_at(vars(var2), str_trim) %>%
        separate_rows(var3, sep = my_sep[3])  %>%
        mutate_at(vars(var3), str_trim) %>%
        select(var2, var3) %>%
        count(var2, var3) %>% 
        #filter(n >= N_min) %>%
        rename(source = var2,
               target = var3)
      
links <- bind_rows(links, links2)

    
nodes <- data.frame(name = c(as.character(links$source),
                             as.character(links$target)) %>%
                      unique())
    
links$IDsource <- match(links$source, nodes$name) - 1 
links$IDtarget <- match(links$target, nodes$name) - 1
    
sankeyNetwork(
      Links = links,
      Nodes = nodes,
      Source = "IDsource",
      Target = "IDtarget",
      Value = "n",
      NodeID = "name",
      #units = "TWh",
      fontSize = 12,
      nodeWidth = 30,
      iterations = 0,
      sinksRight = FALSE)  # ensure node order is as in data
    

```

## Plotting data by country

First, plotting number of publications by country.

```{r}
#| echo: false
#| warning: false
#| label: fig-scatterplot
#| fig-cap: "Number of papers per country."
#| fig-width: 6
#| fig-height: 6

# Note: trying figure labels and resizing

# Summarise data by country
N_country <- df_all %>% 
  drop_na(Country) %>% 
  group_by(Country) %>% 
  summarise(N = n())

# Bar plot
N_country %>% 
  ggplot(aes(x = Country, y= N)) +
  geom_bar(stat = "identity") + 
  ylab("Number of publications") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) 
```

Next, plotting the numbers on a map.

```{r}
#| echo: false
#| warning: false

# Set tmap to be interactive
tmap_mode("view")

# Load world polygon and use tmap to plot
data("World")
World %>% 
  left_join(N_country, 
            by = c("name" = "Country")) %>% 
  tm_shape() +
  tm_polygons("N") 
```

Now map distribution of technologies and taxon by country.

::: {.panel-tabset}

## Technology

```{r}
#| echo: false
#| warning: false

tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"

N_country_tech <- df_all %>% 
  drop_na(Country) %>%
  filter(Marine) %>% 
  separate_rows(Technology, sep = ",")  %>%
  mutate_at(vars(Technology), str_trim) %>%
  filter(Technology != "Wind Energy") %>%
  filter(Technology != "Marine Energy") %>% 
  group_by(Country, Technology) %>% 
  summarise(N = n())

coords <- World %>% 
  left_join(N_country_tech, 
            by = c("name" = "Country")) %>% 
  group_by(name) %>% 
  mutate(x = st_coordinates(st_centroid(geometry))[, 1],
         y = st_coordinates(st_centroid(geometry))[, 2]) %>% 
  pivot_wider(names_from = "Technology",
              values_from = "N") %>% 
  mutate_at(20:25, ~replace_na(.,0))

basemap <- leaflet(width = "100%", height = "400px") %>%
  addTiles(tilesURL)
basemap %>% 
  addMinicharts(
    lng = coords$x, 
    lat = coords$y,
    type = "pie",
    chartdata = as.data.frame(coords[, 20:25])[, 1:5],
  )

```

## Taxon

```{r}
#| echo: false
#| warning: false

tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"

N_country_rec <- df_all %>% 
  drop_na(Country) %>%
  filter(Marine) %>% 
  separate_rows(Receptor, sep = ",")  %>%
  mutate_at(vars(Receptor), str_trim) %>%
  filter(Receptor != "") %>% 
  group_by(Country, Receptor) %>% 
  summarise(N = n())

coords <- World %>% 
  left_join(N_country_rec, 
            by = c("name" = "Country")) %>% 
  group_by(name) %>% 
  mutate(x = st_coordinates(st_centroid(geometry))[, 1],
         y = st_coordinates(st_centroid(geometry))[, 2]) %>% 
  pivot_wider(names_from = "Receptor",
              values_from = "N") %>% 
  mutate_at(20:37, ~replace_na(.,0))

basemap <- leaflet(width = "100%", height = "400px") %>%
  addTiles(tilesURL)
basemap %>% 
  addMinicharts(
    lng = coords$x, 
    lat = coords$y,
    type = "pie",
    chartdata = as.data.frame(coords[, c(20, 22, 23, 24, 26, 27)])[, 1:5],
  )

```

:::


## Statistical analysis: Potential drivers of Scottish funding

Comparing a base model with variables MarineTech, MarMammals, Birds, FishFisheries and Year, with a model that also includes the USTAN binary variable.

```{r}
#| echo: false
#| warning: false

# Generate data
fitdata <- df_all %>%
          separate_rows(Sponsor, sep=",")  %>%
          mutate_at(vars(Sponsor), str_trim) %>%
          drop_na(Sponsor) %>%
          filter(Sponsor!="") %>%
          mutate(MarineTech = str_detect(str_to_lower(Technology), "offshore") | 
                   str_detect(str_to_lower(Technology), "wave") | 
                   str_detect(str_to_lower(Technology), "tidal") | 
                   str_detect(str_to_lower(Technology), "marine")) %>%
          mutate(MarMammals = str_detect(str_to_lower(Receptor), "marine mammals")) %>%
          mutate(Birds = str_detect(str_to_lower(Receptor), "birds")) %>%
          mutate(FishFisheries = str_detect(str_to_lower(Receptor), "fish")) %>%
          mutate(Inverteb = str_detect(str_to_lower(Receptor), "invertebrate")) %>%
          mutate(SocialHumanJustice = str_detect(str_to_lower(Receptor), "social") |
                   str_detect(str_to_lower(Receptor), "human") | 
                   str_detect(str_to_lower(Receptor), "justice")) %>%
          mutate(Scotland = str_detect(str_to_lower(Sponsor), "scot") & 
                   !str_detect(str_to_lower(Sponsor), "scotia"))

# Fit models         
fit0 <- glm(Scotland ~ MarineTech + MarMammals + Birds + FishFisheries + Year,
            data = fitdata, family = binomial(link = "logit"))
# summary(fit0) 
  
fit1 <- glm(Scotland ~ MarineTech + MarMammals + Birds + FishFisheries + Year + USTAN,
            data = fitdata, family = binomial(link = "logit"))
# summary(fit1) 
```

The difference in AIC between the two models is `r AIC(fit1) - AIC(fit0)`. The model ith USTAN is preferred. The estimated coefficients for the two models are:
  
```{r}
#| echo: false

# Summarize model output
r1 <- data.frame(Model = 1, Covariate = rownames(summary(fit0)$coefficients), summary(fit0)$coefficients)
r2 <- data.frame(Model = 2, Covariate = rownames(summary(fit1)$coefficients), summary(fit1)$coefficients)
results <- data.frame(rbind(r1, r2))
rownames(results) <- NULL
colnames(results) <- c("Model", "Covariate","Estimate", "SE", "z-value","p-value")
  
# Print table with results
kable(results, digit = 3) 
  
```

Trying adding a citation [@schwacke2023expert].

## References